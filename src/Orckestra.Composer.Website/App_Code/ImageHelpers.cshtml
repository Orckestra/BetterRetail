@using Composite.Data
@using Composite.Data.Types
@using Orckestra.Media.AutoImageResizing
@using Orckestra.Media.AutoImageResizing.Helpers


@helper PictureTag(DataReference<IImageFile> Image)
{
    var widthBreakpoints = AutoImageResizingConfiguration.WidthBreakpoints;
    var maxWidthLimit = AutoImageResizingConfiguration.MaxWidth;

    @PictureTag(Image, widthBreakpoints.ToArray(), maxWidthLimit)
}

@helper PictureTag(DataReference<IImageFile> Image, int[] widthBreakpoints, int maxWidthLimit)
{
    var imageSupportFormats = AutoImageResizingConfiguration.ImageFormats;

    <picture>
        @foreach (var widthBreakpoint in widthBreakpoints.OrderBy(item => item))
        {
            var mediaRule = $"(max-width: {widthBreakpoint}px)";
            foreach (var mediaType in imageSupportFormats)
            {
                if (ImageFormatSupportHelper.IsSupported(mediaType))
                {
                    var imageUrl = AutoImageResizingHelper.GetResizedImageUrl(Image, widthBreakpoint, mediaType);
                    <source srcset="@imageUrl" media="@mediaRule" type="@mediaType" />
                }
            }
        }
        @{string maxImageWidth = maxWidthLimit > 0 ? "mw=" + maxWidthLimit : string.Empty;}
        <img src="/media(@(Image.KeyValue))?@maxImageWidth" alt="@Image.Data.Title" loading="lazy" />
    </picture>
}

@helper ResponsiveBackgroundImage(DataReference<IImageFile> Image, string cssClass, IHtmlString divContent = null)
{
    var widthBreakpoints = AutoImageResizingConfiguration.WidthBreakpoints;
    var maxWidthLimit = AutoImageResizingConfiguration.MaxWidth;
    @ResponsiveBackgroundImage(Image, cssClass, widthBreakpoints.ToArray(), maxWidthLimit, divContent)
}

@helper ResponsiveBackgroundImage(DataReference<IImageFile> Image, string cssClass, int[] widthBreakpoints, int maxWidthLimit, IHtmlString divContent = null)
{
    <html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://www.composite.net/ns/function/1.0">
    <head>
        @{
            var imageId = Guid.NewGuid();
            var maxImageWidth = maxWidthLimit > 0 ? "mw=" + maxWidthLimit : string.Empty;
        }

        <style type="text/css">
            #@imageId {
                background-image: url('/media(@Image.KeyValue)?@maxImageWidth');
                background-repeat: no-repeat;}
        </style>
        @{
            var imageSupportFormats = AutoImageResizingConfiguration.ImageFormats;
        }

        @foreach (var widthBreakpoint in widthBreakpoints.OrderByDescending(item => item))
        {
            foreach (var mediaType in imageSupportFormats)
            {
                if (ImageFormatSupportHelper.IsSupported(mediaType))
                {
                    var imageUrl = $"/media({Image.KeyValue})?mw={widthBreakpoint}&amp;mt={mediaType}";
                    @:  <style type="text/css"> @@media (max-width: @(widthBreakpoint)px) { #@imageId { background-image: url('@imageUrl');}} </style>
                    }
                }
            }
        </head>
        <body>
            <div class="@cssClass" id="@imageId">@divContent</div>
        </body>
    </html>
    }

